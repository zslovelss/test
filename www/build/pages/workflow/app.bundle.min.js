angular.module("baseConfig",[]).constant("baseConfig",{debug:!1,baseUrl:"http://116.90.82.41:8080/hec_app",workflow_all:"0",workflow_todo:"1",workflow_done:"2",workflow_apply:"3",approve:"1",refuse:"-1",toOther:"0",goBack:"2",addBeforeApprover:"4",addAfterApprover:"5",pageCount:5,historyDisplayMode:{isFixedTop:!1,isOpenModal:!0},multipleLinesDisplayMode:{isPageUpDown:!1,isSlideList:!0}});var utilModule=angular.module("utilModule",[]),HmsModule=angular.module("HmsModule",[]),workflowModule=angular.module("workflowModule",[]),loginModule=angular.module("loginModule",[]),homeModule=angular.module("homeModule",[]),hecModule=angular.module("hecModule",[]),settingModule=angular.module("settingModule",[]),serverPathModule=angular.module("serverPathModule",[]),JPushServiceModule=angular.module("JPushServiceModule",[]);hecModule.directive("hecimgzoom",[function(){return{restrict:"A",scope:!1,link:function(e,o,t){function n(e){var o=e.originalEvent?e.originalEvent.touches:e.touches;D=o[0].clientX,b=o[0].clientY,_=h,y=v,S=0,T=0}function i(e){var t=e.originalEvent?e.originalEvent.touches:e.touches;""===d&&(1===t.length&&f>1?d="swipe":2===t.length&&(d="pinch",m=f,p=a(t),L=t[0].clientX-parseInt((t[0].clientX-t[1].clientX)/2,10)-o[0].offsetLeft-_,k=t[0].clientY-parseInt((t[0].clientY-t[1].clientY)/2,10)-o[0].offsetTop-y)),"swipe"===d?(e.preventDefault(),S=t[0].clientX-D,T=t[0].clientY-b,h=_+S,v=y+T,s()):"pinch"===d&&(e.preventDefault(),u=a(t),g=u/p,f=g*m,h=L*(1-g)+_+S,v=k*(1-g)+y+T,s())}function r(e){var o=e.originalEvent?e.originalEvent.touches:e.touches;""===d||o.length>0||(f<1?(f=1,h=0,v=0):f>w?(f=w,g=f/m,h=L*(1-g)+_+S,v=k*(1-g)+y+T):(h>0?h=0:h<l*(1-f)&&(h=l*(1-f)),v>0?v=0:v<c*(1-f)&&(v=c*(1-f))),s(.1),d="")}function a(e){var o=Math.sqrt(Math.pow(e[0].clientX-e[1].clientX,2)+Math.pow(e[0].clientY-e[1].clientY,2));return parseInt(o,10)}function s(e){var t=e?"all cubic-bezier(0,0,.5,1) "+e+"s":"",n=[f,0,0,f,h,v],i="matrix("+n.join(",")+")";o.css({"-webkit-transition":t,transition:t,"-webkit-transform":i+" translate3d(0,0,0)",transform:i})}var l,c,d="",u=0,p=0,f=1,g=1,m=1,w=parseInt(t.maxScale,10);(isNaN(w)||w<=1)&&(w=3);var h=0,v=0,_=0,y=0,L=0,k=0,D=0,b=0,S=0,T=0,C=new Image;C.onload=function(){l=o[0].clientWidth,c=o[0].clientHeight,o.css({"-webkit-transform-origin":"0 0","transform-origin":"0 0"}),o.on("touchstart",n),o.on("touchmove",i),o.on("touchend",r)},t.ngSrc?C.src=t.ngSrc:C.src=t.src}}}]),homeModule.directive("hecNineBlock",["$timeout","$controller","hmsHttp","$http","baseConfig","$AuHttp",function(e,o,t,n,i,r){return{restrict:"E",scope:!0,templateUrl:"build/pages/home/hecNineBlock.html",compile:function(e){function t(e,t,n){e.config={delegateHandle:n.delegateHandle,baseUrl:n.baseUrl,nineDataRemoteUrl:n.nineDataRemoteUrl,nineDataRemote:[],nineDataLocal:n.nineDataLocal,fromRemote:n.fromRemote,nineBlockData:[],listData:[]},a(e);var i={el:angular.element(t[0]),delegateHandle:n.delegateHandle};o("$nineBlockCtrl",{$scope:e,nineBlockViewOptions:i}),e.refreshTipsCount=function(){console.log(" directive-hecNineBlock: refreshTipsCount"),c(e)}}function a(e){var o=i.baseUrl,t=o+"/modules/hmap/wfl/hmap_wfl_todo_count.svc",a={approve_user_code:e.user_name};n.get("funList.json").success(function(o){var n=o.result.record;n&&n.length&&0!=n.length&&r.request({url:t,para:a}).then(function(o){countList=o.response.count_List,n=l(n,countList),angular.forEach(n,function(e,o){""!=e.fun_code&&"资金划拨"!=e.fun_name||n.splice(o,1)}),e.config.nineBlockData=n,angular.forEach(e.config.nineBlockData,function(o,t){"资金划拨"!=o.fun_name&&""!=o.fun_name||e.config.nineBlockData.splice(t,1)}),console.info(e.config.nineBlockData.length),s(e,e.config.nineBlockData)},function(e){alert(e.response)})})}function s(e,o){}function l(e,o){return angular.forEach(e,function(e){for(var t=0;t<o.length;t++)if(Object.keys(o[t])[0]===e.fun_type){var n=Object.keys(o[t])[0];e.fun_count=o[t][n]}}),e}function c(e){a(e)}return{pre:t}}}}]),HmsModule.directive("hmsLoading",["$rootScope",function(e){return{restrict:"E",template:'<div class="pre-loader"></div>',replace:!0,transclude:!1,controller:["$scope",function(e){}],link:function(e,o,t,n){}}}]),HmsModule.directive("hmsWorkflowList",function(){return{restrict:"EA",replace:!0,transclude:!0,scope:{workflowStatus:"=workflowStatus",workflowName:"=workflowName",workflowTitle:"=workflowTitle",createUserIcon:"=createUserIcon",workflowTypeNameLabel:"=workflowTypeNameLabel",workflowTypeName:"=workflowTypeName",lastApproveUserNameLabel:"=lastApproveUserNameLabel",lastApproveUserName:"=lastApproveUserName",currentNodeLabel:"=currentNodeLabel",currentNode:"=currentNode",createUserNameLabel:"=createUserNameLabel",createUserName:"=createUserName",approveStatusNameLabel:"=approveStatusNameLabel",approveStatusName:"=approveStatusName",approveDateLabel:"=approveDateLabel",approveDate:"=approveDate",commentTextLabel:"=commentTextLabel",commentText:"=commentText",chartStatusNameLabel:"=chartStatusNameLabel",chartStatusName:"=chartStatusName",isTodo:"=isTodo",isDone:"=isDone",isApply:"=isApply",isSelectedImg:"=isSelectedImg",operable:"=operable",instanceDescLabel:"=instanceDescLabel",instanceDesc:"=instanceDesc",instanceAmountLabel:"=instanceAmountLabel",instanceAmount:"=instanceAmount",insDocNumLabel:"=insDocNumLabel",insDocNum:"=insDocNum"},template:'<a class="workflow-list-item"><div class="workflow-list-logo"><img ng-src="{{createUserIcon}}"/></div><div class="workflow-list-header">{{isTodo||isDone?createUserName:workflowName}}</div><div class="workflow-list-content">  <img class="select-img" ng-if="isTodo && !operable" ng-src={{"./build/img/workflow/"+isSelectedImg}}>  <div class="row no-padding content-detail">    <div class="col col-90 no-padding" ng-if="isTodo">      <div class="row no-padding">        <div class="col col-33 no-padding color-type">{{instanceDescLabel}}</div>        <div class="col col-67 no-padding color-content">{{instanceDesc}}</div>      </div>      <div class="row no-padding">        <div class="col col-33 no-padding color-type">{{instanceAmountLabel}}</div>        <div class="col col-67 no-padding color-content">{{instanceAmount}}</div>      </div>    </div>    <div class="col col-90 no-padding" ng-if="isDone ">      <div class="row no-padding">        <div class="col col-33 no-padding color-type">{{instanceDescLabel}}</div>        <div class="col col-67 no-padding color-content">{{instanceDesc}}</div>      </div>      <div class="row no-padding">        <div class="col col-33 no-padding color-type">{{instanceAmountLabel}}</div>        <div class="col col-67 no-padding color-content">{{instanceAmount}}</div>      </div>      <div class="row no-padding">        <div class="col col-33 no-padding color-type">{{approveStatusNameLabel}}</div>        <div class="col col-67 no-padding color-content">{{approveStatusName}}</div>      </div>      <div class="row no-padding">        <div class="col col-33 no-padding color-type">{{approveDateLabel}}</div>        <div class="col col-67 no-padding color-content">{{approveDate}}</div>      </div>      <div class="row no-padding">        <div class="col col-33 no-padding color-type">{{commentTextLabel}}</div>        <div class="col col-67 no-padding color-content">{{commentText}}</div>      </div>    </div>    <div class="col col-90 no-padding" ng-if="isApply">      <div class="row no-padding">        <div class="col col-33 no-padding color-type">{{insDocNumLabel}}</div>        <div class="col col-67 no-padding color-content">{{insDocNum}}</div>      </div>      <div class="row no-padding">        <div class="col col-33 no-padding color-type">{{instanceAmountLabel}}</div>        <div class="col col-67 no-padding color-content">{{instanceAmount}}</div>      </div>    </div>    <div class="col col-10 no-padding col-center workflow-list-select">      <img src="build/img/workflow/select@3x.png"/>    </div>  </div></div></a>',controller:["$scope",function(e){}],link:function(e,o,t){}}}),HmsModule.service("$AuHttp",["$http","$q","$filter","$ionicPopup",function(e,o,t,n){function i(i){var r=o.defer();return e.post(i.url,"_request_data="+encodeURIComponent(t("json")({parameter:i.para})),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e,o,t,i){var a=null,s="undefined"!=typeof e.status;if(s){var l="undefined"!=typeof e.status.errorcode;if(l)if("0"===e.status.errorcode)e&&e.workflow_list&&(e.workflow_list.length?a=e.workflow_list:(a=[],a.push(e.workflow_list))),r.resolve({data:a,status:o,headers:t,config:i,response:e});else{var c;c=angular.isString(e)&&e.indexOf("login")>=0?n.alert({title:"错误",template:"session超时"}):n.alert({title:"错误",template:e.status.errormsg}),r.reject({data:a,status:o,headers:t,config:i,response:e,msgBox:c})}else e.success||(c=n.alert({title:"错误",template:e.error.message}),r.reject({data:a,status:o,headers:t,config:i,response:e,msgBox:c}))}else e.success||(c=n.alert({title:"错误",template:e.error.message}),r.reject({data:a,status:o,headers:t,config:i,response:e,msgBox:c}))}).error(function(e,o,t,i){var a=n.alert({title:"错误",template:"请求失败,请检查网络设置或重试"});r.reject({data:e,status:o,headers:t,config:i,resp:e,msgBox:a})}),r.promise}return{request:i}}]),hecModule.service("$hecFingerLogin",["$hecUtil","$ionicPopup","$q",function(e,o,t){function n(){return l=t.defer(),window.plugins.touchid.isAvailable(function(){s=!0,window.localStorage.isOpenFingerLogin?window.plugins.touchid.verifyFingerprint("Scan your fingerprint please",function(){l.resolve()},function(){l.reject()}):l.reject()},function(){s=!1,l.reject()}),l.promise}function i(o){return!window.localStorage.userName||e.uncompileStr(window.localStorage.userName)!=o}function r(n,r){if(c=t.defer(),i(n)&&(window.localStorage.removeItem("isOpenFingerLogin"),window.localStorage.userName=e.compileStr(n),window.localStorage.userPassword=e.compileStr(r),s))var l=o.show({template:"<div></div>",title:"登录成功",subTitle:"是否开启指纹登录",buttons:[{text:"稍后",onTap:function(){l.close()}},{text:"<b>启用</b>",type:"button-positive",onTap:a}]});return c.resolve(),c.promise}function a(){return d=t.defer(),window.plugins.touchid.isAvailable(function(){window.plugins.touchid.verifyFingerprint("Scan your fingerprint please",function(){window.localStorage.isOpenFingerLogin=!0,d.resolve()},function(){window.localStorage.removeItem("isOpenFingerLogin"),d.reject()})},function(){window.localStorage.removeItem("isOpenFingerLogin");var e=o.alert({title:"提示",template:"您的设备暂不支持指纹登录!"});e.then(function(){d.reject()})}),d.promise}var s=!1,l=null,c=null,d=null;return{fingerLogin:n,isFirstTimeLogin:i,loginSuccessAction:r,openFingerLogin:a}}]),JPushServiceModule.factory("jPushService",function(e){var o={},t=function(e){window.plugins.jPushPlugin.init(),document.addEventListener("jpush.setAlias",e.stac,!1),document.addEventListener("jpush.openNotification",n,!1),window.plugins.jPushPlugin.setDebugMode(!0)},n=function(o){try{ionic.Platform.isIOS()&&window.plugins.jPushPlugin.resetBadge(),console.log(angular.toJson(o,!0)),e.$apply()}catch(t){}},i=function(e){window.plugins.jPushPlugin.isPushStopped(e)},r=function(){window.plugins.jPushPlugin.stopPush()},a=function(){window.plugins.jPushPlugin.resumePush()},s=function(e,o){window.plugins.jPushPlugin.setTagsWithAlias(e,o)},l=function(e){window.plugins.jPushPlugin.setTags(e)},c=function(e){window.plugins.jPushPlugin.setAlias(e)},d=function(){window.plugins.jPushPlugin.resetBadge()};return o.init=t,o.isPushStopped=i,o.stopPush=r,o.resumePush=a,o.setTagsWithAlias=s,o.setTags=l,o.setAlias=c,o.resetBadge=d,o}),HmsModule.factory("hmsHttp",["$http",function(e){var o={};return o.post=function(o,t){return e.post(o,t)},o.get=function(o){return e.get(o)},o}]).factory("hmsPopup",["$ionicLoading","$ionicPopup",function(e,o){var t={};return t.showLoading=function(o){e.show({template:'<ion-spinner icon="ios" class="spinner spinner-ios spinner-stable"></ion-spinner><div style="color: white;font-size: 12px;text-align: center;">'+o+"</div>"})},t.showLoadingNoBackdrop=function(o){e.show({template:'<ion-spinner icon="ios" class="spinner spinner-ios spinner-stable"></ion-spinner><div style="color: white;font-size: 12px;text-align: center;">'+o+"</div>",noBackdrop:!0})},t.hideLoading=function(){e.hide()},t.showToast=function(o){e.show({template:angular.isDefined(o)?o:"操作失败",animation:"fade-in",showBackdrop:!1,maxWidth:200,duration:1500})},t.showLongTimeToast=function(o){e.show({template:angular.isDefined(o)?o:"操作失败",animation:"fade-in",showBackdrop:!1,maxWidth:200,duration:2e3})},t.showShortTimeToast=function(o){e.show({template:angular.isDefined(o)?o:"操作失败",animation:"fade-in",showBackdrop:!1,maxWidth:200,duration:1e3})},t.alert=function(e,t,n){var i=o.alert({title:angular.isDefined(t)?t:"提示",template:e,buttons:[{text:"确定",type:"button-clear button-balanced"}]});i.then(n)},t.confirm=function(e,t,n){var i=o.confirm({title:angular.isDefined(t)?t:"提示",template:e,cancelText:"取消",cancelType:"button-clear button-stable",okText:"确定",okType:"button-clear button-balanced"});i.then(n)},t}]).factory("hmsDateFormat",["$filter",function(e){return{toDate:function(o){return e("date")(o,"yyyy-MM-dd")},toDateTime:function(o){return e("date")(o,"yyyy-MM-dd HH:mm:ss")}}}]),utilModule.service("$hecUtil",function(){function e(e){for(var o=String.fromCharCode(e.charCodeAt(0)+e.length),t=1;t<e.length;t++)o+=String.fromCharCode(e.charCodeAt(t)+e.charCodeAt(t-1));return escape(o)}function o(e){e=unescape(e);for(var o=String.fromCharCode(e.charCodeAt(0)-e.length),t=1;t<e.length;t++)o+=String.fromCharCode(e.charCodeAt(t)-o.charCodeAt(t-1));return o}return{compileStr:e,uncompileStr:o}}),serverPathModule.controller("serverPathCtrl",["$scope","$rootScope","$state","$ionicPopup","baseConfig","$ionicModal",function(e,o,t,n,i,r){e.serverData={baseUrl:window.localStorage.localBaseUrl},e.showHistoryServerUrl=function(){window.localStorage.historyServerUrlList&&0!=window.localStorage.historyServerUrlList.length?e.historyServerUrlListList=JSON.parse(window.localStorage.historyServerUrlList):e.historyServerUrlListList=[],e.historyServerUrlModal.show()},e.hideHistoryServerUrl=function(){e.historyServerUrlModal.hide()},r.fromTemplateUrl("history-serverUrl-modal.html",{scope:e}).then(function(o){e.historyServerUrlModal=o}),e.selectHistoryUrl=function(o){e.serverData.baseUrl=o,e.hideHistoryServerUrl()},e.goLogin=function(){e.serverData.baseUrl&&""!=e.serverData.baseUrl?(window.localStorage.localBaseUrl=e.serverData.baseUrl,i.baseUrl=e.serverData.baseUrl,t.go("login")):n.alert({title:"提示",template:"请填写正确的服务器地址!"})}}]),loginModule.controller("loginCtrl",["$scope","$rootScope","$state","$ionicPopup","$ionicNavBarDelegate","$ionicHistory","$AuHttp","baseConfig","$hecUtil","$hecFingerLogin",function(e,o,t,n,i,r,a,s,l,c){e.$on("$ionicView.enter",function(){i.$getByHandle("HecBodyNavbar").showBar(!1),r.clearCache(),r.clearHistory(),r.nextViewOptions({disableBack:!0,historyRoot:!0})}),e.loginData={user_name:"",user_password:"",user_token:"",registration_id:"",user_lang:""},e.checkbox_savePwd=!1,window.localStorage.user_name&&(e.loginData.user_name=window.localStorage.user_name,window.localStorage.user_password&&(e.loginData.user_password=window.localStorage.user_password,e.checkbox_savePwd=!0)),e.savePassword=function(){e.checkbox_savePwd=!e.checkbox_savePwd,e.loginData.user_password&&(e.checkbox_savePwd?window.localStorage.user_password=e.loginData.user_password:window.localStorage.user_password="")},e.doLogin=function(){if(console.log(e.loginData.base_url),""===e.loginData.user_name||""===e.loginData.user_password)return void n.alert({title:"错误",template:"<div style='text-align:center'>请填写账号密码</div>"});window.localStorage.user_name=e.loginData.user_name,e.checkbox_savePwd?window.localStorage.user_password=e.loginData.user_password:window.localStorage.user_password="";var o=s.baseUrl+"/app_login.svc";if("undefined"!=typeof window.plugins){var i={user_name:e.loginData.user_name,user_password:e.loginData.user_password,user_token:e.loginData.user_token};a.request({url:o,para:i}).then(function(e){var o=e.response.status,n=o.user_name;window.sessionStorage.username=n;var i=[];window.localStorage.historyServerUrlList?(i=JSON.parse(window.localStorage.historyServerUrlList),"-1"==i.indexOf(s.baseUrl)&&(i.push(s.baseUrl),window.localStorage.historyServerUrlList=JSON.stringify(i))):(i.push(s.baseUrl),window.localStorage.historyServerUrlList=JSON.stringify(i)),t.go("home",{userName:n})},function(e,o,t,n){})}else{var i={user_name:e.loginData.user_name,user_password:e.loginData.user_password,user_token:e.loginData.user_token};a.request({url:o,para:i}).then(function(e){var o=e.response.status,n=o.user_name;window.sessionStorage.username=n,t.go("home",{userName:n})},function(e,o,t,n){})}}}]),homeModule.service("$nineBlockDelegate",ionic.DelegateService(["refreshTipCount"])).controller("homeCtrl",["$scope","$rootScope","$state","$ionicHistory","$http","$stateParams","$nineBlockDelegate","$ionicNavBarDelegate",function(e,o,t,n,i,r,a,s){function l(){}e.$on("$stateChangeSuccess",function(e,o,t,i,r){o&&i&&i.name&&"home"==o.name&&(a.$getByHandle("fun-list").refreshTipCount(),n.clearCache())});var c=r.userName;e.user_name=c,e.goState=function(e){var o=e.fun_url,n=e.fun_type;o&&("workflow-list"==o&&t.go(o,{type:n,userName:c}),"setting"==o&&t.go(o))},e.linein=0,e.pan=!1,e.setLine=function(o){return e.linein=o,!1},e.setlie=function(o,t){if(0==e.linein){if(0==o)return!0;if(2==o){if(void 0!=t[e.linein][o-1].fun_name)return!0}else if(void 0!=t[e.linein][o-1].fun_name&&void 0==t[e.linein][o+1].fun_name)return!0}else if(2==e.linein){if(0==o){if(void 0!=t[e.linein-1][o+2].fun_name&&void 0==t[e.linein][o+1].fun_name)return!0}else if(2==o){if(void 0!=t[e.linein][o-1].fun_name)return!0}else if(void 0!=t[e.linein][o-1].fun_name&&void 0==t[e.linein][o+1].fun_name)return!0}else if(0==o){if(void 0!=t[e.linein-1][o+2].fun_name&&void 0==t[e.linein][o+1].fun_name)return!0}else if(2==o){if(void 0!=t[e.linein][o-1].fun_name&&void 0==t[e.linein+1][o-2].fun_name)return!0}else if(void 0!=t[e.linein][o-1].fun_name&&void 0==t[e.linein][o+1].fun_name)return!0;return!1},e.refreshTipsCount=function(){a.$getByHandle("fun-list").refreshTipCount()},l()}]).controller("$nineBlockCtrl",["$scope","$nineBlockDelegate","$ionicHistory",function(e,o,t){var n=this;o._registerInstance(n,e.config.delegateHandle,function(){return t.isActiveScope(e)});n.refreshTipCount=function(){console.log(" $nineBlockCtrl -- self.refreshTipCount "),e.refreshTipsCount()}}]),settingModule.controller("settingCtrl",["$scope","$ionicHistory","$ionicPopup","$ionicModal","baseConfig","$AuHttp","$state",function(e,o,t,n,i,r,a){var s=i.baseUrl;e.changePassWordData={user_name:"",old_password:"",new_password:"",confirm_new_password:""},e.changePassWord=function(){if(e.changePassWordData.old_password&&e.changePassWordData.new_password&&e.changePassWordData.confirm_new_password&&""!=e.changePassWordData.old_password&&""!=e.changePassWordData.new_password&&""!=e.changePassWordData.confirm_new_password){var o=s+"/password_modify.svc",n={user_name:window.sessionStorage.username,old_password:e.changePassWordData.old_password,new_password:e.changePassWordData.new_password,confirm_password:e.changePassWordData.confirm_new_password};r.request({url:o,para:n}).then(function(o){console.log(o.response.status);var n=t.alert({title:"提示",template:o.response.status.errormsg});n.then(function(){e.changePassWordModal.hide().then(function(){e.changePassWordData={user_name:"",old_password:"",new_password:"",confirm_new_password:""},a.go("login")})})},function(e){})}else t.alert({title:"提示",template:"请按要求填写信息!"})},n.fromTemplateUrl("change-password-modal.html",{scope:e}).then(function(o){e.changePassWordModal=o}),e.openChangePassWord=function(){e.changePassWordModal.show()},e.hideChangePassWord=function(){e.changePassWordData={user_name:"",old_password:"",new_password:"",confirm_new_password:""},e.changePassWordModal.hide()},e.goBack=function(){o.goBack()},e.logout=function(){var e=s+"/app_logout.svc",o={};r.request({url:e,para:o}).then(function(){a.go("login")},function(){a.go("login")})}}]);var wxApp=angular.module("wxApp",["ionic","baseConfig","utilModule","HmsModule","workflowModule","loginModule","homeModule","ngCordova","hecModule","settingModule","serverPathModule","JPushServiceModule"]);wxApp.run(["$ionicPlatform",function(e){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&(StatusBar.styleDefault(),StatusBar.backgroundColorByHexString("#3c9bd3"))})}]).config(["$httpProvider","$stateProvider","$ionicConfigProvider","$urlRouterProvider",function(e,o,t,n){t.platform.ios.tabs.style("standard"),t.platform.ios.tabs.position("bottom"),t.platform.android.tabs.style("standard"),t.platform.android.tabs.position("bottom"),t.platform.ios.navBar.alignTitle("center"),t.platform.android.navBar.alignTitle("center"),t.platform.ios.backButton.previousTitleText("").icon("ion-ios-arrow-thin-left"),t.platform.android.backButton.previousTitleText("").icon("ion-android-arrow-back"),t.platform.ios.views.transition("ios"),t.platform.android.views.transition("android"),t.backButton.text("").previousTitleText("").icon("ion-chevron-left"),t.scrolling.jsScrolling(!0),o.state("login",{url:"/login",templateUrl:"build/pages/login/login.html",controller:"loginCtrl"}).state("home",{url:"/home/{userName}",templateUrl:"build/pages/home/home.html",controller:"homeCtrl"}).state("workflow-list",{url:"/workflow-list/{type}/{userName}",templateUrl:"build/pages/workflow/list/list.html",controller:"workflowListCtrl"}).state("workflow-detail",{url:"/workflow-detail/{template_code}/{instance_id}/{node_id}/{record_id}",templateUrl:"build/pages/workflow/detail/detail.html",controller:"workflowDetailCtrl"}).state("atm_priview",{url:"/atm_priview/{url}",templateUrl:"build/pages/workflow/detail/atm_priview.html",controller:"AtmPriviewController"}).state("setting",{url:"/setting",templateUrl:"build/pages/setting/setting.html",controller:"settingCtrl"}),n.otherwise("/login")}]),workflowModule.factory("workflowService",["$timeout","baseConfig","hmsHttp","hmsPopup","$window","$AuHttp","$stateParams",function(e,o,t,n,i,r,a){var s=o.baseUrl,l=102,c="工作流类型",d="上一节点",u="当前节点",p="提交人",f="审批状态",g="审批时间",m="审批意见",w="状态",h="描述",v="金额",_="单据编号",y={};y.doWorkflowActionSuccess=!1,y.getSourceList=function(e){var o=function(o){o.success?(e.sourceList=o.rows,y.source=e.sourceList[0],angular.forEach(e.sourceList,function(o){var t={itemCode:o.source_id,itemName:o.source_name,selected:!1};o.source_id==y.source.source_id&&(t.selected=!0,e.filterTypeList=[{typeCode:"SOURCE",typeName:"数据来源",selected:!0},{typeCode:"TEMPLATE",typeName:"工作流类型",selected:!1}],angular.forEach(o.condition,function(o){var t={typeCode:o.conditionTypeCode.toUpperCase(),typeName:o.conditionTypeName,selected:!1};e.filterTypeList.push(t);var n=o.conditionTypeCode,i=n.replace(/_(\w)/g,function(e){return e.slice(1).toUpperCase()}),r=i+"List";e.filterConditionOption.extra[r]=[];var a=n+"_code";e.filterCondition.extra[a]=""})),e.filterConditionOption.sourceList.push(t)}),e.filterItemList=e.filterConditionOption.sourceList,e.filterConditionOption.currentCheckedType="SOURCE",y.getListData(e)):(e.isLoadingData=!1,n.showLongTimeToast("获取数据来源失败"))},i=function(o,t){y.getListData(e),401!=t&&404!=t&&n.showLongTimeToast("获取数据来源失败")},r=s+"/i/api/mobileApi/getSourceList";t.get(r).success(function(e){o(e)}).error(function(e,o){i(e,o)})},y.getListData=function(e){e.pageNum=1;var o=function(o){k(!1,e,o)},t=function(o,t){e.isLoadingData=!1,e.isRefresh&&(e.isRefreshingData=!1,e.$broadcast("scroll.refreshComplete"))};L(!1,e,o,t)};var L=function(e,t,n,i){e?t.isLoadingMoreData=!0:(t.list=[],t.isLoadingData=!0,t.canLoadMoreData=!1,t.isRefresh&&(t.isRefreshingData=!0));var a=s+"/modules/hmap/wfl/hmap_wfl_todo_list_query_and_batch_approve.svc",l={action:"getWorkflowList",workflow_condition:{approve_user_code:window.sessionStorage.username,workflow_status:t.filterCondition.workflow_status,condition:t.filterCondition.condition,template_code:t.filterCondition.template_code,page:t.pageNum,page_count:o.pageCount,code:t.code}};r.request({url:a,para:l}).then(function(e){n(e.response)},function(e){i(e.response)})},k=function(e,t,i){if(i.status&&"0"==i.status.errorcode){var r=i.workflow_list,a=[];angular.forEach(r,function(e){var o=e.create_user_code;a.push(o)});var s=function(n){for(var i=0;i<r.length;i++)r[i].create_user_icon="build/img/head.png";angular.forEach(r,function(e){var o={is_todo:t.workflowStatus.isTodo,is_done:t.workflowStatus.isDone,is_apply:t.workflowStatus.isApply,create_user_icon:e.create_user_icon,workflow_title:e.workflow_title,workflow_name:e.workflow_name,workflow_type_name_label:c,workflow_type_name:e.workflow_name,last_approve_user_name_label:d,last_approve_user_name:e.last_approve_user_name||e.create_user_name,current_node_label:u,current_node:e.current_node,create_user_name_label:p,create_user_name:e.create_user_name,approve_status_name_label:f,approve_status_name:e.approve_status_name,approve_date_label:g,approve_date:e.approve_date,comment_text_label:m,comment_text:e.comment_text||"无",chart_status_name_label:w,chart_status_name:e.chart_status_name,create_user_code:e.create_user_code,template_code:e.template_code,instance_id:e.source_instance_id,record_id:e.source_record_id,node_id:e.source_node_id,instance_desc_label:h,instance_desc:e.instance_desc,instance_amount_label:v,instance_amount:e.instance_amount,ins_doc_num_label:_,ins_doc_num:e.ins_doc_num};t.list.push(o)}),!r||r.length<o.pageCount?t.canLoadMoreData=!1:t.canLoadMoreData=!0,e?(t.isLoadingMoreData=!1,t.$broadcast("scroll.infiniteScrollComplete")):(t.isLoadingData=!1,t.isRefresh&&(t.isRefreshingData=!1,t.$broadcast("scroll.refreshComplete")))},l=function(o,n){t.canLoadMoreData=!1,e?(t.isLoadingMoreData=!1,t.$broadcast("scroll.infiniteScrollComplete")):(t.isLoadingData=!1,t.isRefresh&&(t.isRefreshingData=!1,t.$broadcast("scroll.refreshComplete")))};b(a,s,l)}else t.canLoadMoreData=!1,e?(t.isLoadingMoreData=!1,t.$broadcast("scroll.infiniteScrollComplete")):(t.isLoadingData=!1,t.isRefresh&&(t.isRefreshingData=!1,t.$broadcast("scroll.refreshComplete"))),n.showLongTimeToast("获取审批列表失败")};y.getMoreListData=function(e){e.pageNum+=1;var o=function(o){k(!0,e,o)},t=function(o,t){e.canLoadMoreData=!1,e.isLoadingMoreData=!1,e.$broadcast("scroll.infiniteScrollComplete")};e.isLoadingMoreData||L(!0,e,o,t)},y.getDetailData=function(e,o){e.isLoadingData=!0;var t=function(o){S(e,o),e.isLoadingData=!1},n=function(o,t){e.isLoadingData=!1};D(o,t,n)},y.getTransmitPerson=function(e,t,n,i){var a=s+"/modules/hmap/exp/hmap_emp_info_query.svc",l={action:"getUserList",condition:e,page:t,page_count:o.pageCount,current_user_code:window.sessionStorage.username};r.request({url:a,para:l}).then(function(e){n(e.response)},function(e){i(e.response)})},y.doWorkflowAction=function(e,o,t,i,a,l){var c=s+"/modules/hmap/wfl/hmap_wfl_workflow_approve.svc",d={};if("4"==e||"5"==e){var u="";u="4"==e?"BEFORE":"AFTER",d={action:"setWorkflowStatus",template_code:o.template_code,source_instance_id:o.instance_id,source_node_id:o.node_id,source_record_id:o.record_id,workflow_status:{action:"5",priority:u,current_user_code:window.sessionStorage.username,forward_user_code:t,comment_text:i,timestamp:(new Date).getTime()}}}else d={action:"setWorkflowStatus",template_code:o.template_code,source_instance_id:o.instance_id,source_node_id:o.node_id,source_record_id:o.record_id,workflow_status:{action:e,current_user_code:window.sessionStorage.username,forward_user_code:t,comment_text:i,timestamp:(new Date).getTime()}};r.request({url:c,para:d}).then(function(e){n.hideLoading(),a(e.response)},function(e){n.hideLoading(),l(e.response)})},y.doWorkflowActionBatch=function(e,o){e.isLoadingData=!0;var t=function(o){e.list=e.list.filter(function(e){return 1!=e.selected}),e.isLoadingData=!1,e.operable=!0,n.showLongTimeToast("工作流处理成功")},i=function(o,t){e.isLoadingData=!1,401!=t&&404!=t&&n.showLongTimeToast("工作流处理失败")},a=s+"/modules/hmap/wfl/hmap_wfl_todo_list_query_and_batch_approve.svc",l=e.list.filter(function(e){return 1==e.selected}).map(function(e){return{template_code:e.template_code,source_instance_id:e.instance_id,source_node_id:e.node_id,source_record_id:e.record_id,workflow_status:{action:o,current_user_code:window.sessionStorage.username,forward_user_code:"",comment_text:"",timestamp:(new Date).getTime()}}});if(0==l.length)return n.showLongTimeToast("请选中待办事项"),void(e.isLoadingData=!1);var c={action:"setWorkflowStatusBatch",workflow:l};r.request({url:a,para:c}).then(function(e){t(e.response)},function(e){i(e.response)})};var D=function(e,o,t){var n=s+"/modules/hmap/wfl/hmap_wfl_doc_info_query.svc",i={action:"getWorkflowDetail",template_code:e.template_code,source_instance_id:e.instance_id,source_node_id:e.node_id,source_record_id:e.record_id,current_user_code:window.sessionStorage.username};r.request({url:n,para:i}).then(function(e){o(e.response)},function(e){t(e.response)})},b=function(e,o,t){var n={};o(n)},S=function(e,o){if(o.status&&"0"==o.status.errorcode&&(e.currentDetail=o,e.historyList=o.history,C(e,o.history.length),o.workflow_data)){e.attachmentList=o.workflow_data.attachments,e.singleArrayList=o.workflow_data.details,angular.forEach(e.singleArrayList,function(e){e.showFlag=!0});var t=o.workflow_data.line_areas;e.multipleArrayList=[],angular.forEach(t,function(o){e.multipleArrayList.push(T(o))})}},T=function(e){var o={title:e.line_area_title,arrayList:e.lines,currentPage:1,currentArray:[],showFlag:!0};if(e.lines.length){for(var t=[],n=e.line_titles,i=e.lines[0].line,r=0;r<i.length;r++){var a={line_title:n[r].line_title,line_value:i[r].line_value};t.push(a)}o.currentArray=t}return o},C=function(e,o){var t=document.body.clientWidth;try{t=parseInt(o)*l}catch(n){}e.historyWidth={width:t+"px"}};return y}]),workflowModule.controller("workflowDetailCtrl",["$scope","$stateParams","$ionicModal","$ionicHistory","$timeout","$ionicScrollDelegate","$ionicBackdrop","baseConfig","hmsPopup","workflowService","$state","$ionicPlatform",function(e,o,t,n,i,r,a,s,l,c,d,u){function p(e){var o=e.split(".");return o[o.length-1]}function f(e){var o=["png","jpg","bmp","jpeg","gif","icon","ico"];return o.indexOf(e)>-1&&(console.log("2"),!0)}var g=1;e.showMore=!1,e.historyDisplayMode=s.historyDisplayMode,e.multipleLinesDisplayMode=s.multipleLinesDisplayMode,e.isOpenMore=!1,e.attachmentShowFlag=!0,e.isLoadingData=!1,e.isLoadingTransmitPerson=!1,e.canLoadMoreData=!1,e.historyList=[],e.singleArrayList=[],e.multipleArrayList=[],e.attachmentList=[],e.transmitPerson=[],e.processInfo={opinion:"",transmitPersonCondition:"",transmitPerson:{user_code:"",user_desc:""},approverList:[],actionType:""},e.actionType={approve:s.approve,refuse:s.refuse,toOther:s.toOther,addBeforeApprover:s.addBeforeApprover,addAfterApprover:s.addAfterApprover},e.historyScrollWidth={width:document.body.clientWidth+"px"},e.generalUtil={openWorkflowHistoryModal:function(){e.workflowHistoryModal.show()},closeWorkflowHistoryModal:function(){e.workflowHistoryModal.hide()},showHistoryComment:function(e){l.alert(e||"无","审批意见")},toggleContent:function(e,o){var t=r.$getByHandle("workflowDetailHandle").getScrollView();if(e.showFlag=!e.showFlag,e.showFlag&&o.pageY+15>t.__clientHeight){var n=r.$getByHandle("workflowDetailHandle").getScrollPosition();r.$getByHandle("workflowDetailHandle").scrollTo(0,n.top+300,!0)}r.resize()},toggleAttachmentContent:function(o){var t=r.$getByHandle("workflowDetailHandle").getScrollView();if(e.attachmentShowFlag=!e.attachmentShowFlag,e.attachmentShowFlag&&o.pageY+15>t.__clientHeight){var n=r.$getByHandle("workflowDetailHandle").getScrollPosition();r.$getByHandle("workflowDetailHandle").scrollTo(0,n.top+300,!0)}r.resize()},openUrl:function(e,o){e=s.baseUrl+"/"+e,ionic.Platform.isIOS()?window.open(e,"_system","location=yes"):f(p(o))?d.go("atm_priview",{url:e}):cordova.plugins.OfficePlugin.openFileByFileUrl(function(){},function(){
l.showLongTimeToast("附件打开失败")},e,!1)},previous:function(e){if(e.currentPage>1){var o=e.currentArray,t=o.length;e.currentPage-=1;for(var n=0;n<t;n++)o[n].line_value=e.arrayList[e.currentPage-1].line[n].line_value}},next:function(e){if(e.currentPage<e.arrayList.length){var o=e.currentArray,t=o.length;e.currentPage+=1;for(var n=0;n<t;n++)o[n].line_value=e.arrayList[e.currentPage-1].line[n].line_value}},openTransmitPersonModal:function(o){e.processInfo.actionType=o,e.transmitPersonModal.show()},closeTransmitPersonModal:function(){e.transmitPersonModal.hide()},selectTransmitPerson:function(o){e.processInfo.transmitPerson=o,e.transmitPersonModal.hide(),i(function(){m(e.processInfo.actionType)},300)},checkApprover:function(o){o.checked=!o.checked,o.checked?e.processInfo.approverList.push(o):e.processInfo.approverList.remove(o)},confirmApprover:function(){e.processInfo.approverList.length?(e.transmitPersonModal.hide(),i(function(){m(e.processInfo.actionType)},300)):l.alert("请先添加审批人")},searchTransmitPerson:function(){if(e.processInfo.transmitPersonCondition){g=1,e.isLoadingTransmitPerson=!0;var o=function(o){o.status&&"0"==o.status.errorcode&&(e.transmitPerson=o.user_list,o.user_list.length<s.pageCount?e.canLoadMoreData=!1:e.canLoadMoreData=!0),e.isLoadingTransmitPerson=!1},t=function(o,t){e.canLoadMoreData=!1,e.isLoadingTransmitPerson=!1};c.getTransmitPerson(e.processInfo.transmitPersonCondition,g,o,t)}},searchMoreTransmitPerson:function(){if(e.processInfo.transmitPersonCondition){g+=1;var o=function(o){o.status&&"0"==o.status.errorcode&&(Array.prototype.push.apply(e.transmitPerson,o.user_list),o.user_list.length<s.pageCount?e.canLoadMoreData=!1:e.canLoadMoreData=!0,e.$broadcast("scroll.infiniteScrollComplete"))},t=function(o,t){e.canLoadMoreData=!1};c.getTransmitPerson(e.processInfo.transmitPersonCondition,g,o,t)}},validateWorkflowAction:function(o){o==e.actionType.approve?m(o):o==e.actionType.refuse?e.processInfo.opinion?m(o):l.alert("请输入拒绝原因","提示",w):o==e.actionType.toOther?e.processInfo.opinion?this.openTransmitPersonModal(o):l.alert("请输入转交原因","提示",w):o==e.actionType.addBeforeApprover?this.openTransmitPersonModal(o):o==e.actionType.addAfterApprover?this.openTransmitPersonModal(o):l.alert("请输入处理类型")},toggleMore:function(){e.isOpenMore=!e.isOpenMore}},t.fromTemplateUrl("build/pages/workflow/modal/transmit/transmit-person-modal.html",{scope:e}).then(function(o){e.transmitPersonModal=o}),t.fromTemplateUrl("workflow-history-modal.html",{scope:e}).then(function(o){e.workflowHistoryModal=o});var m=function(t){var n=e.processInfo.opinion,i="",r=function(t){t.status&&"0"==t.status.errorcode?"detail"==d.page?(l.showShortTimeToast("工作流处理成功,即将更新数据"),setTimeout(function(){c.getDetailData(e,o)},1e3)):(c.doWorkflowActionSuccess=!0,l.showShortTimeToast("工作流处理成功"),setTimeout(function(){window.history.back()},1e3)):l.showShortTimeToast("工作流处理失败")},a=function(e,o){},s=function(e){e&&(l.showLoading("工作流处理中…"),c.doWorkflowAction(t,o,i,n,r,a))};if(t==e.actionType.toOther)i=e.processInfo.transmitPerson.user_code,l.confirm("是否确认转交给："+e.processInfo.transmitPerson.user_desc+"?",void 0,s);else if(t==e.actionType.addBeforeApprover||t==e.actionType.addAfterApprover){for(var u=e.processInfo.approverList,p=u.length,f='<div style="text-align: left">添加如下审批人：</div>',g=0;g<p;g++)f+='<div style="text-align: left;padding: 0 20px">'+(g+1)+". "+u[g].user_desc+"</div>";f+='<div style="text-align: left">是否确认?</div>',f='<div style="display: inline-block">'+f+"</div>";var m=[];angular.forEach(u,function(e){m.push(e.user_code)}),i=m.join(","),l.confirm(f,void 0,s)}else l.confirm("是否确认提交处理工作流?",void 0,s)},w=function(e){h(),i(function(){document.querySelector("#option").focus()},0)},h=function(){r.$getByHandle("workflowDetailHandle").scrollBottom(!0)};Array.prototype.contains=function(e){for(var o=0;o<this.length;o++)if(this[o]===e)return!0;return!1},Array.prototype.indexOf=function(e){for(var o=0;o<this.length;o++)if(this[o]==e)return o;return-1},Array.prototype.remove=function(e){var o=this.indexOf(e);o>-1&&this.splice(o,1)},c.getDetailData(e,o),e.goBack=function(){n.goBack()}}]).controller("AtmPriviewController",["$scope","$state","$stateParams","$sce","$ionicHistory",function(e,o,t,n,i){e.priviewUrl=n.trustAsResourceUrl(t.url),e.goBack=function(){i.goBack()}}]),workflowModule.controller("workflowListCtrl",["$scope","$state","$stateParams","$ionicModal","$timeout","$ionicScrollDelegate","baseConfig","workflowService","$ionicHistory",function(e,o,t,n,i,r,a,s,l){function c(){"todo"==e.type?e.workflowStatus={code:a.workflow_todo,isTodo:!0,isDone:!1,isApply:!1}:"done"==e.type?e.workflowStatus={code:a.workflow_done,isTodo:!1,isDone:!0,isApply:!1}:"apply"==e.type?e.workflowStatus={code:a.workflow_apply,isTodo:!1,isDone:!1,isApply:!0}:e.workflowStatus={code:a.workflow_all,isTodo:!1,isDone:!1,isApply:!1},e.filterCondition.workflow_status=e.workflowStatus.code,e.pageNum=1,e.isLoadingData=!1,e.isRefresh=!1,e.isRefreshingData=!1,e.canLoadMoreData=!1,e.isLoadingMoreData=!1,e.list=[],e.currentItemIndex}function d(){window.sessionStorage.token&&window.sessionStorage.username?s.source?e.loadListData():s.getSourceList(e):s.getListData(e)}var u=null;e.operable=!0,e.workflowStatus={code:"",isTodo:!1,isDone:!1,isApply:!1},e.type=t.type,e.filterTypeList=[],e.filterItemList=[],e.sourceList=[],e.filterConditionOption={currentCheckedType:"",sourceList:[],templateList:[],extra:{}},e.filterCondition={workflow_status:e.workflowStatus.code,condition:"",template_code:"",extra:{}},c(),e.$on("$stateChangeSuccess",function(o,t,n,i,r){"workflow-list"==t.name&&"workflow-detail"==i.name&&s.doWorkflowActionSuccess&&(e.loadListData(),s.doWorkflowActionSuccess=!1)}),e.loadListData=function(o){o?e.isRefresh=!0:e.isRefresh=!1,s.getListData(e)},e.loadMoreListData=function(){s.getMoreListData(e)},e.goDetail=function(t,n){return e.operable||"todo"!=e.type?(e.currentItemIndex=n,void o.go("workflow-detail",{template_code:t.template_code,instance_id:t.instance_id,node_id:t.node_id,record_id:t.record_id})):void(t.selected=!t.selected)},e.selectAll=function(){e.list.forEach(function(e){e.selected=!0})},e.reject=function(){s.doWorkflowActionBatch(e,a.refuse)},e.allow=function(){s.doWorkflowActionBatch(e,a.approve)},e.operableOrNot=function(){e.operable||e.list.forEach(function(e){e.selected=!1}),e.operable=!e.operable},n.fromTemplateUrl("build/pages/workflow/modal/filter/hms-filter-modal.html",{scope:e}).then(function(o){e.workflowFilterModal=o}),e.openWorkflowFilterModal=function(){e.workflowFilterModal.show()},e.dataFilterHandle={cancelDataFilter:function(){e.workflowFilterModal.hide()},clearDataFilterParams:function(){e.workflowFilterModal.hide()},confirmDataFilter:function(){e.workflowFilterModal.hide(),r.$getByHandle("workflowListHandle").scrollTop(),e.loadListData()},selectFilterType:function(o){if(angular.forEach(e.filterTypeList,function(e){e.selected=!1}),o.selected=!0,r.$getByHandle("hmsFilterCondition").scrollTop(),e.filterConditionOption.currentCheckedType=o.typeCode,e.filterItemList=[],"SOURCE"==o.typeCode)e.filterItemList=e.filterConditionOption.sourceList;else if("TEMPLATE"==o.typeCode)e.filterConditionOption.templateList.length?e.filterItemList=e.filterConditionOption.templateList:s.getTemplateList(e);else{var t=o.typeCode.toLowerCase(),n=t.replace(/_(\w)/g,function(e){return e.slice(1).toUpperCase()}),i=n+"List";e.filterConditionOption.extra[i].length?e.filterItemList=e.filterConditionOption.extra[i]:s.getExtraCondition(e,t)}},selectFilterItem:function(o){if(angular.forEach(e.filterItemList,function(e){e.selected=!1}),o.selected=!0,"SOURCE"==e.filterConditionOption.currentCheckedType){if(u=s.source,angular.forEach(e.sourceList,function(e){if(e.source_id==o.itemCode)return s.source=e,!1}),u!=s.source){e.filterCondition.template_code="",s.getListData(e),e.filterConditionOption.templateList=[];for(var t in e.filterConditionOption.extra)e.filterCondition.extra[t]=[];e.filterTypeList=[{typeCode:"SOURCE",typeName:"数据来源",selected:!0},{typeCode:"TEMPLATE",typeName:"工作流类型",selected:!1}],angular.forEach(s.source.condition,function(o){var t={typeCode:o.conditionTypeCode.toUpperCase(),typeName:o.conditionTypeName,selected:!1};e.filterTypeList.push(t)})}}else if("TEMPLATE"==e.filterConditionOption.currentCheckedType)e.filterCondition.template_code=o.itemCode;else{var n=e.filterConditionOption.currentCheckedType.toLowerCase()+"_code";e.filterCondition.extra[n]=o.itemCode}}},d(),e.toggleType=function(o){e.operable&&o!=e.type&&(e.operable=!0,e.type=o,c(),d())},navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)&&document.body.addEventListener("touchmove",function(e){e.preventDefault()},!1),e.goBack=function(){l.goBack()}}]);